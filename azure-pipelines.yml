# This pipeline runs multiple stages
# release stage uses a 'special' deployment job
# this is a 'minumum template' to use in productuin

trigger:
- master # pipeline will run on new commits to specified branch

variables:
  subscriptionConnectionName: 'My subscription connection'
  subscriptionId: '6dca9329-fb22-46cb-826c-e26edc8a4840'
  poolName: 'Windows-latest'
  deploymeneLocation: 'Norway East'

# normally build stages will build an application along with the infrastructure
stages:
  - stage: BUILD
    jobs:
    - job:
      displayName: 'copy templates as artifacts'
      steps:
        - task: PublishPipelineArtifact@1
          inputs:
            targetPath: '$(Pipeline.Workspace)'
            artifact: 'resourceTemplates'
            publishLocation: 'pipeline'

 # production scenarios often require a more complex test. In this case we verify the arm tempate 
  - stage: TEST
    jobs:
    - job:
      displayName: 'Verify ARM template'
      steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Subscription'
            azureResourceManagerConnection: $(subscriptionConnectionName)  #defined in variable
            subscriptionId: $(subscriptionId) #defined in variable
            location: $(deploymentLocation) #defined in variable
            templateLocation: 'Linked artifact'
            csmFile: '\'
            deploymentMode: 'Validation'
  
  - stage: RELEASE
    dependsOn: TEST
    jobs:
      - deployment: 'deploy Azure resources'
        environment: 'arm-livestreams'
        strategy:
          runOnce:
            deploy:
              steps:
              - script: echo Hi!